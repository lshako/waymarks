<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Visited Places Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="shortcut icon" href="/favicon.ico" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; }
        #map { width: 100%; height: 100%; }
        .leaflet-popup-content { font-size: 14px; }
    </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@7.2.0/turf.min.js"></script>

<script>
    const worldBounds = [[-90, -180], [90, 180]];

    const map = L.map('map', {
        maxBounds: worldBounds,      // prevent panning outside the world
        maxBoundsViscosity: 1.0,     // stop map from moving outside bounds
        worldCopyJump: false          // disable horizontal wrapping
    }).setView([46.8, 8.3], 3);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map tiles © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors | Country data © <a href="https://github.com/georgique/world-geojson">world-geojson</a>',
        maxZoom: 18,
        minZoom: 2,
        noWrap: true
    }).addTo(map);

    // Layer groups
    const countriesLayer = L.layerGroup();
    const citiesLayer = L.layerGroup().addTo(map);
    const summitsLayer = L.layerGroup();

    // Layer control
    const overlayMaps = {
        "Countries": countriesLayer,
        "Cities": citiesLayer,
        "Summits": summitsLayer,
    };
    L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);

    function loadGeoJSON(url, layer, options) {
        fetch(url)
            .then(r => r.json())
            .then(data => L.geoJSON(data, options).addTo(layer))
            .catch(err => console.error(`Failed to load ${url}:`, err));
    }

    function titleCase(str) {
        return str
            .split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(' ');
    }

    function loadCountry(name) {
        fetch(`countries-geo/${name.toLowerCase()}.json`)
            .then(res => res.json())
            .then(data => {
                L.geoJSON(data, {
                    style: (feature) => {
                        if (name.toLowerCase() === "russia") {
                            return {
                                color: "#999",
                                weight: 0.5,
                                fillColor: "#0077cc",
                                fillOpacity: 0.5
                            };
                        }
                        return {
                            color: "#333",
                            weight: 1,
                            fillColor: "#0077cc",
                            fillOpacity: 0.5
                        };
                    },
                    onEachFeature: (feature, layer) => {
                        const countryName = feature.properties.NAME || name;
                        layer.bindPopup(`<b>${countryName}</b>`);
                    }
                }).addTo(countriesLayer);
            })
            .catch(err => console.error(`Failed to load ${name}:`, err));
    }

    fetch('countries.json')
        .then(res => res.json())
        .then(visitedCountries => {
            visitedCountries.forEach(name =>
                loadCountry(name)
            );
        });

    fetch('countries.json')
        .then(res => res.json())
        .then(countries => {
            countries.forEach(country => {
                const fileName = `cities/${country.toLowerCase().replace(/ /g, '_')}.json`;
                fetch(fileName)
                    .then(res => res.json())
                    .then(citiesMap => {
                        Object.entries(citiesMap).forEach(([cityName, coords]) => {
                            L.marker([coords.lat, coords.lon])
                                .bindPopup(`<b>${cityName}</b><br>${titleCase(country)}`)
                                .addTo(citiesLayer);
                        });
                    })
                    .catch(err => console.warn(`No city file for ${country}:`, err));
            });
        })
        .catch(err => console.error('Failed to load countries.json:', err));

    const violetIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png',
        shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });


    loadGeoJSON('summits.json', summitsLayer, {
        pointToLayer: (f, latlng) => L.marker(latlng, { icon: violetIcon }),
        onEachFeature: (f, layer) => {
            const name = f.properties.name || "Unknown summit";
            const elevation = f.properties.elevation ? f.properties.elevation + " m" : "";
            const date = f.properties.date || "";
            layer.bindPopup(`<b>${name}</b><br>${elevation}<br>${date}`);
        }
    });

</script>
</body>
</html>
